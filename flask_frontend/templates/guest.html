<!doctype html>
<html><head><title>Event: {{ code }}</title></head><body>
  <h1>Event: {{ code }}</h1>
  <input id="s"><button onclick="s()">Search</button>
  <ul id="results"></ul>
  <h2>Queue</h2><ul id="q"></ul>
  <script>
    const c="{{code}}";
    async function s(){
      const qv=document.getElementById("s").value;
      const res=await fetch(`/api/search?q=${qv}`);
      const arr=await res.json();
      document.getElementById("results").innerHTML=arr.map(s=>`<li>${s.title} – ${s.artist}
        <button onclick="a('${s.track_id}','${s.title}','${s.artist}')">Add</button></li>`).join("");
    }
    async function a(id,t,ar){
      await fetch('/api/items/add',{method:'POST',headers:{'Content-Type':'application/json'},
        body:JSON.stringify({code:c,item:{track_id:id,title:t,artist:ar}})});
      lq();
    }
    async function v(id){
      await fetch('/api/items/vote',{method:'POST',headers:{'Content-Type':'application/json'},
        body:JSON.stringify({id})});
      lq();
    }
    async function lq(){
      const r=await fetch(`/api/events/${c}`);
      const items=(await r.json()).items.sort((a,b)=>b.votes-a.votes);
      document.getElementById("q").innerHTML=items.map(i=>`<li>${i.title} – ${i.artist} (${i.votes})
        <button onclick="v(${i.id})">▲</button></li>`).join("");
    }
    setInterval(lq,3000); lq();
  </script>
</body></html>
